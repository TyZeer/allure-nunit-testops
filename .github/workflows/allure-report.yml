name: Allure Report

env:
    SOLUTION_FILE: Allure.Examples.NUnit3.sln
    BUILD_CONFIGURATION: Debug
    ALLURE_RESULTS: "allure-results"
    ALLURE_JOB_RUN_ID: ${{ github.event.inputs.ALLURE_JOB_RUN_ID }}

on:
  workflow_dispatch:
    inputs:
      GITHUB_TESTS_ENDPOINT:
        description: "System under test"
        required: true
        default: https://system.under.test
      GITHUB_TESTS_BROWSER:
        description: "Browser to be used in tests"
        required: true
        default: chrome
      ALLURE_JOB_RUN_ID:
        description: "ALLURE_JOB_RUN_ID is service parameter required for triggering workflows from Allure TestOps. Leave blank."
        required: false
      ALLURE_USERNAME:
        description: "ALLURE_USERNAME service parameter. Leave blank"
        required: false
      


jobs:
    autotests:
        name: Run tests and generate Allure Report
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
  
            - name: Set up .NET
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: |
                    7.0.x

            - name: Restore NuGet packages
              run: dotnet restore --packages .packages ${{ env.SOLUTION_FILE }}

            - name: Build solution
              run: dotnet build --no-restore --configuration ${{ env.BUILD_CONFIGURATION }} ${{ env.SOLUTION_FILE }}
            - name: install and configure allurectl using GH Action
              uses: allure-framework/setup-allurectl@v1
              with:
                  allure-endpoint: https://demo.testops.cloud
                  allure-token: ${{ secrets.ALLURE_TOKEN }}
                  allure-project-id: 9999
            
            - name: Test solution
              run: allurectl watch -- dotnet test --no-build --configuration ${{ env.BUILD_CONFIGURATION }} ${{ env.SOLUTION_FILE }}
              continue-on-error: true
              env:
                GITHUB_TESTS_ENDPOINT: ${{ github.event.inputs.GITHUB_TESTS_ENDPOINT }}
                GITHUB_TESTS_BROWSER: ${{ github.event.inputs.GITHUB_TESTS_BROWSER }}
                GITHUB_TESTS_BRANCH: ${{ github.ref_name }}

            
